apiVersion: v1
kind: Namespace
metadata:
  name: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rest-test-server
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: rest-test-server
  template:
    metadata:
      labels:
        app.kubernetes.io/component: rest-test-server
    spec:
      containers:
      - name: rest-test-server
        image: akribuilds.azurecr.io/rest-test-server:0.3.1
        ports:
        - containerPort: 8080
          name: http-anon
          protocol: TCP
        - containerPort: 8081
          name: http-basic
          protocol: TCP
        - containerPort: 8443
          name: https-anon
          protocol: TCP
        - containerPort: 8444
          name: https-basic
          protocol: TCP
        - containerPort: 8445
          name: https-mtls
          protocol: TCP
        env:
        - name: TLS_CERT_PATH
          value: /secrets/server/server.crt
        - name: TLS_KEY_PATH
          value: /secrets/server/server.key
        - name: TLS_CA_PATH
          value: /secrets/ca/ca.crt
        - name: TLS_INTERMEDIATE_PATH
          value: /secrets/intermediate/intermediate.crt
        - name: AUTH_USERNAME_PATH
          value: /secrets/auth/username
        - name: AUTH_PASSWORD_PATH
          value: /secrets/auth/password
        volumeMounts:
        - name: root-ca-cert
          mountPath: /secrets/ca
          readOnly: true
        - name: intermediate-cert
          mountPath: /secrets/intermediate
          readOnly: true
        - name: server-cert-and-key
          mountPath: /secrets/server
          readOnly: true
        - name: auth-secret
          mountPath: /secrets/auth
          readOnly: true
      volumes:
        - name: root-ca-cert
          secret:
            secretName: rest-test-server-root-ca
            items:
            - key: tls.crt
              path: ca.crt
        - name: intermediate-cert
          secret:
            secretName: rest-test-server-intermediate-cert
            items:
            - key: tls.crt
              path: intermediate.crt
        - name: server-cert-and-key
          secret:
            secretName: rest-test-server-application-cert
            items:
            - key: tls.crt
              path: server.crt
            - key: tls.key
              path: server.key
        - name: auth-secret
          secret:
            secretName: rest-test-server-auth-creds
            items:
            - key: usernameKey
              path: username
            - key: passwordKey
              path: password
      serviceAccountName: rest-test-server-service-account
---
apiVersion: v1
kind: Service
metadata:
  name: rest-test-server
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/component: rest-test-server
  ports:
  - name: http-anon
    port: 8080
    targetPort: 8080
    protocol: TCP
  - name: http-basic
    port: 8081
    targetPort: 8081
    protocol: TCP
  - name: https-anon
    port: 8443
    targetPort: 8443
    protocol: TCP
  - name: https-basic
    port: 8444
    targetPort: 8444
    protocol: TCP
  - name: https-mtls
    port: 8445
    targetPort: 8445
    protocol: TCP
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: rest-test-server-self-signed-issuer
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
spec:
  selfSigned: {}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: rest-test-server-root-ca
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
spec:
  secretName: rest-test-server-root-ca
  duration: 8760h # 1 year
  renewBefore: 720h # 30d
  issuerRef:
    name: rest-test-server-self-signed-issuer
    kind: Issuer
  commonName: "Rest Test Server Root CA"
  usages:
    - digital signature
    - key encipherment
    - cert sign
    - crl sign
  privateKey:
    encoding: PKCS8
    algorithm: ECDSA
    size: 521
  isCA: true
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: rest-test-server-root-ca-issuer
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
spec:
  ca:
    secretName: rest-test-server-root-ca
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: rest-test-server-intermediate-cert
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
spec:
  secretName: rest-test-server-intermediate-cert
  duration: 4380h # 6 months
  renewBefore: 360h # 15d
  issuerRef:
    name: rest-test-server-root-ca-issuer
    kind: Issuer
  commonName: "Rest Test Server Intermediate CA"
  usages:
    - digital signature
    - key encipherment
    - cert sign
    - crl sign
  privateKey:
    encoding: PKCS8
    algorithm: ECDSA
    size: 521
  isCA: true
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: rest-test-server-intermediate-issuer
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
spec:
  ca:
    secretName: rest-test-server-intermediate-cert
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: rest-test-server-application-cert
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
spec:
  secretName: rest-test-server-application-cert
  duration: 2160h # 90d
  renewBefore: 360h # 15d
  issuerRef:
    name: rest-test-server-intermediate-issuer
    kind: Issuer
  commonName: RestTestServer
  dnsNames:
    - rest-test-server
    - rest-test-server.rest-simulator.svc.cluster.local
    - rest-test-server.rest-simulator
  uris:
    - urn:RestTestServer:rest-test-server
  usages:
    - digital signature
    - key encipherment
    - data encipherment
    - server auth
    - client auth
  privateKey:
    encoding: PKCS8
    algorithm: ECDSA
    size: 521
  encodeUsagesInRequest: true
  isCA: false
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: rest-test-server-client-cert
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
spec:
  secretName: rest-test-server-client-cert
  duration: 2160h # 90d
  renewBefore: 360h # 15d
  issuerRef:
    name: rest-test-server-intermediate-issuer
    kind: Issuer
  commonName: "Rest Test Server Client"
  dnsNames:
    - client
    - rest-test-client
  usages:
    - digital signature
    - key encipherment
    - client auth
  privateKey:
    encoding: PKCS8
    algorithm: ECDSA
    size: 521
  isCA: false
---
apiVersion: v1
kind: Secret
metadata:
  name: rest-test-server-auth-creds
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
type: Opaque
data:
  usernameKey: dXNlcm5hbWU=  # base64 encoded "username"
  passwordKey: cGFzc3dvcmQ=  # base64 encoded "password"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rest-test-server-service-account
  namespace: rest-simulator
  labels:
    app.kubernetes.io/component: rest-test-server
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rest-test-server-secret-access-role
  namespace: rest-simulator
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rest-test-server-secret-access-rolebinding
  namespace: rest-simulator
subjects:
- kind: ServiceAccount
  name: rest-test-server-service-account
  namespace: rest-simulator
roleRef:
  kind: Role
  name: rest-test-server-secret-access-role
  apiGroup: rbac.authorization.k8s.io