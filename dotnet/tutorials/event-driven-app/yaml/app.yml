apiVersion: v1
kind: ServiceAccount
metadata:
  name: event-driven-app
  namespace: azure-iot-operations
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: event-driven-app
  namespace: azure-iot-operations
spec:
  selector:
    matchLabels:
      app: event-driven-app
  template:
    metadata:
      labels:
        app: event-driven-app
    spec:
      serviceAccountName: event-driven-app

      volumes:
        - name: event-driven-app-token
          projected:
            sources:
              - serviceAccountToken:
                  path: event-driven-app-token
                  audience: aio-internal
                  expirationSeconds: 86400
        - name: aio-ca-trust-bundle
          configMap:
            name: aio-ca-trust-bundle-test-only

      containers:
        - name: event-driven-app
          image: event-driven-app # Pull image from k3d cluster
          imagePullPolicy: Never
          volumeMounts:
            - name: event-driven-app-token
              mountPath: /var/run/secrets/tokens/
            - name: aio-ca-trust-bundle
              mountPath: /var/run/certs/aio-ca/
          env:
            - name: MQTT_HOST_NAME
              value: "aio-broker"
            - name: MQTT_TCP_PORT
              value: "8883"
            - name: MQTT_USE_TLS
              value: "true"
            - name: MQTT_CA_FILE
              value: "/var/run/certs/aio-ca/ca.crt"
            - name: MQTT_SAT_AUTH_FILE
              value: "/var/run/secrets/tokens/event-driven-app-token"
