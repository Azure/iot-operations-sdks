name: CI-dotnet

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'dotnet/**'
      - 'eng/test/test-cases/Protocol/**'
      - 'tools/dsscli/**'
      - 'codegen/**'
  push:
    branches:
    - main  
  schedule:
  - cron: '0 11 * * *'  # Nightly at 4am PST

permissions:
  contents: read
  actions: read
  checks: write
    
jobs:
  build:

    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.301
    
    - name: dotnet info
      run: dotnet --info

    - name: Setup Cluster
      run: |
        tools/deployment/initialize-cluster.sh
        tools/deployment/deploy-aio.sh nightly
        
    - name: Build SDK (Debug)
      run: dotnet build -c Debug dotnet/Azure.Iot.Operations.sln

    - name: Deploy HTTP thermostat connector sample
      run: (cd dotnet/samples/HttpThermostatConnectorApp; ./deploy-connector-and-asset.sh)

    - name: Output Connector App Logs
      run:  |
        for node in $(kubectl get pods -o name);
        do
          echo ${pod}
          if [[ ${pod} == my-http-*]]
          then
            kubectl logs ${pod} 
          fi
        done

    - uses: dorny/test-reporter@v1
      id: test-reporter
      if: always()
      with:
        name: dotnet test report
        path: 'dotnet/**/test-results.trx,tools/**/test-results.trx'
        reporter: dotnet-trx  

    - name: Annotate Test Report
      if: always()
      run: echo Test Report ${{ steps.test-reporter.outputs.url_html }} >> $GITHUB_STEP_SUMMARY