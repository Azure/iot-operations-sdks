# OPC UA Companion Spec Conversion

This folder contains tooling for generating DTDL models from OPC UA companion specs, and it also contains the models generated by this tooling.

## Contents of this folder tree

### Tool folders

* Opc2Yaml &mdash; Tool that extracts relevant information from OPC UA Nodeset2 files into intermediate YAML format

* FilterYaml &mdash; Tool that filters YAML files to retaion only content that will be used in further processing

* DedupYaml &mdash; Tool that removes from a subtype all explicitly defined elements that conflict with inherited elements

* Yaml2Dtdl &mdash; Tool that produces DTDL models from YAML files that have been filtered and deduped

* UnitMatcher &mdash; Tool that produces the UnitTypes.csv file used by Yaml2Dtdl to determine quantitative types and units

### Library folders

* OpcUaDigest &mdash; Library used by FilterYaml, DedupYaml, and Yaml2Dtdl to parse intermediate YAML files

* SpecMapper &mdash; Library used by Opc2Yaml and Yaml2Dtdl to map between namespace URIs and spec names

### Data folders

* YamlDigests &mdash; Output from Opc2Yaml tool; input to FilterYaml tool

* FilteredDigests &mdash; Output from FilterYaml tool; input to DedupYaml tool

* DedupedDigests &mdash; Output from DedupYaml tool; input to Yaml2Dtdl tool

* DtdlModels &mdash; Output from Yaml2Dtdl tool

### Top-level files

* Opc2Dtdl.sln &mdash; Visual Studio solution file

* UnitTypes.csv &mdash; Mapping from OPC UA Unit IDs to DTDL quantitative types and units;  produced by UnitMatcher and used by Yaml2Dtdl

* resolver.json &mdash; Configuration for DTDLParser to resolve external references when validating the generated DTDL

## Building and running the tools

All projects are included in the Opc2Dtdl.sln solution and can be built by the command:

```dotnetcli
dotnet build
```
Assuming a clone of the [OPCFoundation/UA-Nodeset](https://github.com/OPCFoundation/UA-Nodeset) repository is available locally in folder `../../../UA-Nodeset`, the following command will extract relevant information from the NodeSet files into YAML files.

```dotnetcli
Opc2Yaml/bin/Debug/net8.0/Opc2Yaml ../../../UA-Nodeset ./YamlDigests
```

Then, the following sequence of commands will filter, dedup, and convert the YAML files into DTDL models.
The last command in the sequence will also use the [DTDLParser](https://github.com/digitaltwinconsortium/DTDLParser) to validate the generated DTDL.

```dotnetcli
FilterYaml/bin/Debug/net8.0/FilterYaml ./YamlDigests ./FilteredDigests
DedupYaml/bin/Debug/net8.0/DedupYaml ./FilteredDigests ./DedupedDigests
Yaml2Dtdl/bin/Debug/net8.0/Yaml2Dtdl ./DedupedDigests ./DtdlModels ./UnitTypes.csv ./resolver.json
```

## Examaple companion spec conversion

As an example, here is the flow for the CommercialKitchenEquipment companion spec.
The CommercialKitchenEquipment Nodeset2 file is in the OPCFoundation/UA-Nodeset repo:

[../../../UA-Nodeset/CommercialKitchenEquipment/Opc.Ua.CommercialKitchenEquipment.NodeSet2.xml](https://github.com/OPCFoundation/UA-Nodeset/blob/latest/CommercialKitchenEquipment/Opc.Ua.CommercialKitchenEquipment.NodeSet2.xml)

When the `Opc2Yaml` tool runs on the previous file, it observes that the CommercialKitchenEquipment spec points to the DI companion spec as a required model, and so it reads this next file as well:

[../../../UA-Nodeset/DI/Opc.Ua.Di.NodeSet2.xml](https://github.com/OPCFoundation/UA-Nodeset/blob/latest/DI/Opc.Ua.Di.NodeSet2.xml)

The `Opc2Yaml` tool then writes the extracted information into this intermediate YAML file:

[./YamlDigests/CommercialKitchenEquipment.digest.yaml](./YamlDigests/CommercialKitchenEquipment.digest.yaml)

The `FilterYaml` tool reads the previous file and writes a filtered version of the information to this next file:

[./FilteredDigests/CommercialKitchenEquipment.digest.yaml](./FilteredDigests/CommercialKitchenEquipment.digest.yaml)

The `DedupYaml` tool reads the previous file and writes a deduped version of the information to this next file:

[./DedupedDigests/CommercialKitchenEquipment.digest.yaml](./DedupedDigests/CommercialKitchenEquipment.digest.yaml)

The `Yaml2Dtdl` reads the previous file, generates DTDL models, and writes the models into files in the following folder:

[./DtdlModels/CommercialKitchenEquipment](./DtdlModels/CommercialKitchenEquipment/)
