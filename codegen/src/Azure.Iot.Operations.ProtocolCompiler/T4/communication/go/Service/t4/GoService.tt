<#@ template language="C#" linePragmas="false" #>
// Code generated by Azure.Iot.Operations.ProtocolCompiler v<#=System.Reflection.Assembly.GetExecutingAssembly().GetName().Version#>; DO NOT EDIT.
package <#=this.genNamespace.GetFolderName(TargetLanguage.Go)#>

import (
<# if ((this.generateServer && this.cmdEnvoyInfos.Any()) || (this.generateClient && this.separateTelemetries && this.telemEnvoyInfos.Any())) { #>
	"context"

<# } #>
	"github.com/Azure/iot-operations-sdks/go/protocol"
)

<# if (this.generateServer) { #>
<# if (this.cmdEnvoyInfos.Any()) { #>
type <#=this.serviceName.GetTypeName(TargetLanguage.Go, "command", "handlers")#> interface {
<# foreach (var cmdEnvoyInfo in this.cmdEnvoyInfos) { #>

	<#=cmdEnvoyInfo.Name.GetMethodName(TargetLanguage.Go)#>(
		context.Context,
		*protocol.CommandRequest[<#=this.AsSchema(cmdEnvoyInfo.RequestSchema)#>],
	) (*protocol.CommandResponse[<#=this.AsSchema(cmdEnvoyInfo.NormalResultSchema ?? cmdEnvoyInfo.ResponseSchema)#>], error)
<# } #>
}

<# } #>
type <#=this.serviceName.GetTypeName(TargetLanguage.Go, "service")#> struct {
	protocol.Listeners
<# foreach (var cmdEnvoyInfo in this.cmdEnvoyInfos) { #>
	*<#=cmdEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "command", "executor")#>
<# } #>
<# foreach (var telemEnvoyInfo in this.telemEnvoyInfos) { #>
	*<#=telemEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "telemetry", "sender")#>
<# } #>
}

<# } #>
<# if (this.generateClient) { #>
<# if (this.separateTelemetries && this.telemEnvoyInfos.Any()) { #>
type <#=this.serviceName.GetTypeName(TargetLanguage.Go, "telemetry", "handlers")#> interface {
<# foreach (var telemEnvoyInfo in this.telemEnvoyInfos) { #>

	<#=telemEnvoyInfo.Name.GetMethodName(TargetLanguage.Go)#>(
		context.Context,
		*protocol.TelemetryMessage[<#=this.AsSchema(telemEnvoyInfo.Schema)#>],
	) error
<# } #>
}

<# } #>
type <#=this.serviceName.GetTypeName(TargetLanguage.Go, "client")#> struct {
	protocol.Listeners
<# foreach (var cmdEnvoyInfo in this.cmdEnvoyInfos) { #>
	*<#=cmdEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "command", "invoker")#>
<# } #>
<# foreach (var telemEnvoyInfo in this.telemEnvoyInfos) { #>
	*<#=telemEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "telemetry", "receiver")#>
<# } #>
}

<# } #>
const (
<# if (this.doesCommandTargetService || this.doesTelemetryTargetService) { #>
	ModelID = "<#=this.modelId#>"
<# } #>
<# if (this.commandTopic != null) { #>
	CommandTopic = "<#=this.commandTopic#>"
<# } #>
<# if (this.telemetryTopic != null) { #>
	TelemetryTopic = "<#=this.telemetryTopic#>"
<# } #>
)
<# if (this.generateServer) { #>

func <#=this.serviceName.GetMethodName(TargetLanguage.Go, "service", prefix: "new")#>(
	app *protocol.Application,
	client protocol.MqttClient,
<# if (this.cmdEnvoyInfos.Any()) { #>
	commandHandlers <#=this.serviceName.GetTypeName(TargetLanguage.Go, "command", "handlers")#>,
<# } #>
	opts ...protocol.Option,
) (*<#=this.serviceName.GetTypeName(TargetLanguage.Go, "service")#>, error) {
	var err error

	serverOpts := []protocol.Option{
<# if (this.cmdServiceGroupId != null) { #>
		protocol.WithShareName("<#=this.cmdServiceGroupId#>"),
<# } #>
		protocol.WithTopicTokenNamespace("ex:"),
		protocol.WithTopicTokens{
<# if (this.doesCommandTargetService || this.doesTelemetryTargetService) { #>
			"modelId":    ModelID,
<# } #>
<# if (this.commandTopic != null) { #>
			"executorId": client.ID(),
<# } #>
<# if (this.telemetryTopic != null) { #>
			"senderId":   client.ID(),
<# } #>
		},
	}
<# if (this.cmdEnvoyInfos.Any()) { #>

	var executorOpts protocol.CommandExecutorOptions
	executorOpts.ApplyOptions(opts, serverOpts...)
<# } #>
<# if (this.telemEnvoyInfos.Any()) { #>

	var senderOpts protocol.TelemetrySenderOptions
	senderOpts.ApplyOptions(opts, serverOpts...)
<# } #>

	<#=this.serviceName.GetVariableName(TargetLanguage.Go, "service")#> := &<#=this.serviceName.GetTypeName(TargetLanguage.Go, "service")#>{}
<# foreach (var cmdEnvoyInfo in this.cmdEnvoyInfos) { #>

	<#=this.serviceName.GetVariableName(TargetLanguage.Go, "service")#>.<#=cmdEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "command", "executor")#>, err = <#=cmdEnvoyInfo.Name.GetMethodName(TargetLanguage.Go, "command", "executor", prefix: "new")#>(
		app,
		client,
		CommandTopic,
		commandHandlers.<#=cmdEnvoyInfo.Name.GetMethodName(TargetLanguage.Go)#>,
		&executorOpts,
	)
	if err != nil {
		<#=this.serviceName.GetVariableName(TargetLanguage.Go, "service")#>.Close()
		return nil, err
	}
	<#=this.serviceName.GetVariableName(TargetLanguage.Go, "service")#>.Listeners = append(<#=this.serviceName.GetVariableName(TargetLanguage.Go, "service")#>.Listeners, <#=this.serviceName.GetVariableName(TargetLanguage.Go, "service")#>.<#=cmdEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "command", "executor")#>)
<# } #>
<# foreach (var telemEnvoyInfo in this.telemEnvoyInfos) { #>

	<#=this.serviceName.GetVariableName(TargetLanguage.Go, "service")#>.<#=telemEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "telemetry", "sender")#>, err = <#=telemEnvoyInfo.Name.GetMethodName(TargetLanguage.Go, "telemetry", "sender", prefix: "new")#>(
		app,
		client,
		TelemetryTopic,
		&senderOpts,
	)
	if err != nil {
		<#=this.serviceName.GetVariableName(TargetLanguage.Go, "service")#>.Close()
		return nil, err
	}
<# } #>

	return <#=this.serviceName.GetVariableName(TargetLanguage.Go, "service")#>, nil
}
<# } #>
<# if (this.generateClient) { #>

func <#=this.serviceName.GetMethodName(TargetLanguage.Go, "client", prefix: "new")#>(
	app *protocol.Application,
	client protocol.MqttClient,
<# if (this.telemEnvoyInfos.Any()) { #>
<# if (this.separateTelemetries) { #>
	telemetryHandlers <#=this.serviceName.GetTypeName(TargetLanguage.Go, "telemetry", "handlers")#>,
<# } else { #>
	telemetryHandler protocol.TelemetryHandler[<#=this.AsSchema(this.telemEnvoyInfos.First().Schema)#>],
<# } #>
<# } #>
	opts ...protocol.Option,
) (*<#=this.serviceName.GetTypeName(TargetLanguage.Go, "client")#>, error) {
	var err error

	clientOpts := []protocol.Option{
<# if (this.telemServiceGroupId != null) { #>
		protocol.WithShareName("<#=this.telemServiceGroupId#>"),
<# } #>
		protocol.WithTopicTokenNamespace("ex:"),
		protocol.WithTopicTokens{
<# if (this.doesCommandTargetService || this.doesTelemetryTargetService) { #>
			"modelId":    ModelID,
<# } #>
<# if (this.commandTopic != null) { #>
			"invokerClientId": client.ID(),
<# } #>
		},
	}
<# if (this.cmdEnvoyInfos.Any()) { #>

	var invokerOpts protocol.CommandInvokerOptions
	invokerOpts.ApplyOptions(opts, clientOpts...)
<# } #>
<# if (this.telemEnvoyInfos.Any()) { #>

	var receiverOpts protocol.TelemetryReceiverOptions
	receiverOpts.ApplyOptions(opts, clientOpts...)
<# } #>

	<#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#> := &<#=this.serviceName.GetTypeName(TargetLanguage.Go, "client")#>{}
<# foreach (var cmdEnvoyInfo in this.cmdEnvoyInfos) { #>

	<#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>.<#=cmdEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "command", "invoker")#>, err = <#=cmdEnvoyInfo.Name.GetMethodName(TargetLanguage.Go, "command", "invoker", prefix: "new")#>(
		app,
		client,
		CommandTopic,
		&invokerOpts,
	)
	if err != nil {
		<#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>.Close()
		return nil, err
	}
	<#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>.Listeners = append(<#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>.Listeners, <#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>.<#=cmdEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "command", "invoker")#>)
<# } #>
<# foreach (var telemEnvoyInfo in this.telemEnvoyInfos) { #>

	<#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>.<#=telemEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "telemetry", "receiver")#>, err = <#=telemEnvoyInfo.Name.GetMethodName(TargetLanguage.Go, "telemetry", "receiver", prefix: "new")#>(
		app,
		client,
		TelemetryTopic,
<# if (this.separateTelemetries) { #>
		telemetryHandlers.<#=telemEnvoyInfo.Name.GetMethodName(TargetLanguage.Go)#>,
<# } else { #>
		telemetryHandler,
<# } #>
		&receiverOpts,
	)
	if err != nil {
		<#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>.Close()
		return nil, err
	}
	<#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>.Listeners = append(<#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>.Listeners, <#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>.<#=telemEnvoyInfo.Name.GetTypeName(TargetLanguage.Go, "telemetry", "receiver")#>)
<# } #>

	return <#=this.serviceName.GetVariableName(TargetLanguage.Go, "client")#>, nil
}
<# } #>
<#+
	    private string AsSchema(ITypeName schema) => schema?.GetTypeName(TargetLanguage.Go) ?? "any";
#>
